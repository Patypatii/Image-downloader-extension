(()=>{const e=function(e,t){return new Promise(r=>{if(document.querySelector(e))return r(document.querySelector(e));const a=new MutationObserver(t=>{document.querySelector(e)&&(a.disconnect(),r(document.querySelector(e)))});a.observe(document.body,{childList:!0,subtree:!0}),setTimeout(()=>{a.disconnect(),r(null)},t)})},t=async function(e=1e3,t=5){let r=0;for(;r<t;){const a=document.documentElement.scrollHeight;if(window.scrollTo(0,document.documentElement.scrollHeight),await new Promise(t=>setTimeout(t,e)),document.documentElement.scrollHeight===a){console.log("No more content loaded after scroll, stopping auto-scroll.");break}r++,console.log(`Scrolled ${r}/${t}.`)}},r=e=>chrome.runtime.sendMessage({action:"updateLoading",message:e});chrome.runtime.onMessage.addListener(async(a,o,n)=>{if("startScraping"===a.action){console.log("Content script: Received startScraping request.");let a=[],o={pageTitle:document.title,url:window.location.href,scrapedImages:[],scrapedCount:0,lastError:null};try{const c=await new Promise(e=>{chrome.storage.sync.get({scrapeCssBackgrounds:!1,minImageWidth:50,maxScrolls:5},e)}),i=window.location.hostname;let s;i.includes("jumia.co.ke")||i.includes("jumia.com")?(await r("Applying Jumia specific scraping..."),s=await async function(t){const a=new Set,o={productInfo:{platform:"Jumia"},lastError:null};r("Scraping Jumia product page...");try{const r=await e(".product-image-gallery__image img",15e3);if(!r)throw new Error("Jumia main product image not found after timeout.");r.src&&r.naturalWidth>=t.minImageWidth&&a.add(r.src),document.querySelectorAll(".gallery-thumb-list img").forEach(e=>{const r=e.src||e.dataset.src;r&&r.startsWith("http")&&e.naturalWidth>=t.minImageWidth&&a.add(r)});const n=document.querySelector(".product-name");n&&(o.productInfo.name=n.textContent.trim());const c=document.querySelector(".product-price");c&&(o.productInfo.price=c.textContent.trim())}catch(e){throw console.error("Jumia scraping error:",e),o.lastError=`Jumia specific scraping failed: ${e.message}`,e}return{images:Array.from(a),data:o}}(c)):i.includes("facebook.com")?(await r("Applying Facebook specific scraping..."),s=await async function(e){const a=new Set,o={posts:[],platform:"Facebook",lastError:null};r("Scraping Facebook page...");try{await t(2e3,e.maxScrolls),document.querySelectorAll("img").forEach(t=>{t.src&&t.src.startsWith("http")&&t.naturalWidth>=e.minImageWidth&&(t.src.includes("emoji")||t.src.includes("profile_picture")||a.add(t.src))}),o.images=Array.from(a)}catch(e){throw console.error("Facebook scraping error:",e),o.lastError=`Facebook specific scraping failed: ${e.message}`,e}return{images:Array.from(a),data:o}}(c)):(await r("Applying generic scraping..."),s=await async function(a){const o=new Set,n={genericInfo:{},lastError:null};if(r("Extracting basic info..."),n.genericInfo.pageTitle=document.title,n.genericInfo.url=window.location.href,r("Waiting for dynamic content..."),await e("body",15e3),r(`Scrolling to load more images (max ${a.maxScrolls} scrolls)...`),await t(1500,a.maxScrolls),document.querySelectorAll("img").forEach(e=>{let t=e.src;if(e.srcset){const r=e.srcset.split(",").map(e=>e.trim().split(" ")[0]).find(e=>e&&e.startsWith("http"));r&&(t=r)}t&&!t.startsWith("data:")&&t!==window.location.href||(t=e.getAttribute("data-src")||e.getAttribute("data-original")||t),t&&t.startsWith("http")&&"about:blank"!==t&&e.naturalWidth>=a.minImageWidth&&o.add(t)}),a.scrapeCssBackgrounds){r("Checking CSS backgrounds (this may take time)...");const e=document.querySelectorAll("div, span, a, section, article, header, footer, li");for(const t of e){const e=window.getComputedStyle(t).backgroundImage;if(e&&"none"!==e&&!e.includes("gradient")){const t=e.match(/url\(['"]?(.*?)['"]?\)/);if(t&&t[1]){let e=t[1];e=e.replace(/&amp;/g,"&"),e.startsWith("http")&&!e.includes("data:image")&&o.add(e)}}}}return n.images=Array.from(o),n.genericInfo.scrapedCount=n.images.length,{images:n.images,data:n}}(c)),a=s.images,o={pageTitle:document.title,url:window.location.href,...s.data,scrapedImages:a,scrapedCount:a.length},await r(`Found ${a.length} images. Sending data to popup...`),chrome.runtime.sendMessage({action:"scrapedData",images:a,data:o}),n({success:!0,message:"Scraping complete. Data sent."})}catch(e){console.error("Content script main scraping error:",e);const t=`Scraping failed: ${e.message}`;o.lastError=e.message,chrome.runtime.sendMessage({action:"error",message:t}),n({success:!1,message:t})}return!0}})})();